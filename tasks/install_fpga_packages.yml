---
# Copyright 2019 Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Fail if fpga_rsu_driver_pkg_url is undefined and empty
  fail:
    msg: "fpga_rsu_driver_pkg_url is a mandatory variable"
  when:
    - not (( fpga_rsu_driver_pkg_url is defined) and (fpga_rsu_driver_pkg_url | length > 0))

- name: Create fpga driver package directory if not exist
  file:
    path: "{{ fpga_rsu_driver_dir }}"
    state: directory
    mode: 0755

- name: Download and untar FPGA driver tarball
  block:
    - name: Set fact for rpm tarball name
      set_fact:
        fpga_rsu_tarball_name: "{{ fpga_rsu_driver_pkg_url | basename }}"

    - name: Download fpga driver tarball
      copy:
        src: "{{ fpga_rsu_driver_pkg_url }}"
        dest: "{{ fpga_rsu_driver_dir }}/{{ fpga_rsu_tarball_name }}"
      failed_when: false

    - name: untar fpga driver tarball
      unarchive:
        src: "{{ fpga_rsu_driver_dir }}/{{ fpga_rsu_tarball_name }}"
        dest: "{{ fpga_rsu_driver_dir }}"
      register: fpga_driver_tarball_untar
      failed_when: false


- name: Install packages and verify installation
  block:
    - name: setting fact for fpga driver rpm directory
      set_fact:
        fpga_driver_rpm_dir: "{{ fpga_rsu_driver_dir }}/{{ fpga_rsu_tarball_name | splitext | first | splitext | first }}"

    - name: Install fpga drivers
      shell:
        rpm -ivh *
      args:
        chdir: "{{ fpga_driver_rpm_dir }}/opae"
      register: opae_packages_installed

    - name: Fail when OPAE FPGA package installation failed
      fail:
        msg: "OPAE FPGA package installation failed."
      when: opae_packages_installed.rc != 0

    - name: Verify opae and intel packages installed
      shell: |-
        set -o pipefail
        rpm -qa | grep 'opae\|intel'
      when: opae_packages_installed.rc == 0

    - name: Verify opae driver installation
      shell: |-
        set -o pipefail
        lsmod | grep fpga
        lsmod | grep pac_n3000_net
      register: verify_opae_driver

- name: Verify module is loaded in kernel and update flash
  block:
    - name: Verify linux has enumerated Intel FPGA PAC n3000 FPGA management Engine
      shell: |-
        set -o pipefail
        lspci | grep 0b30
      register: check_linux_enumerated_fpga_mgmt_engine

    - name: Fail if opae driver installation failed
      fail:
        msg: >-
          OPAE driver installation failed. Either module is not loaded in kernel or
          linux failed to enumerated Intel FPGA PAC n3000 FPGA management Engine.
      when: verify_opae_driver.rc != 0 or check_linux_enumerated_fpga_mgmt_engine.rc != 0

    - name: Update the flash to remote system update of board
      shell:
        fpgaflash user chip_rsu-2x2x25G.bin --rsu
      args:
        chdir: "{{ fpga_driver_rpm_dir }}/A10/factory_image"
      register: fpgaflash_rsu_update

    - name: Fail when Remote system update of board failed
      fail:
        msg: Remote system update of board failed using fpgaflash
      when: fpgaflash_rsu_update.rc != 0

